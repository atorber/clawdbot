<view class="container chat-container">
  <view class="status-bar">
    <view class="status-pill">
      <view class="status-dot status-dot-{{connectionState}}"></view>
      <text class="status-text">{{connectionStateText}}</text>
    </view>
    <view class="icon-btns">
      <image class="icon-btn" src="/images/{{ connected ? 'icon-link-off' : 'icon-refresh' }}.svg" mode="aspectFit" bindtap="toggleConnect" />
      <image class="icon-btn" src="/images/icon-settings.svg" mode="aspectFit" bindtap="goConfig" />
    </view>
  </view>
  <scroll-view class="message-list" scroll-y scroll-into-view="{{scrollToId}}" scroll-with-animation bindtap="clearMessageActions">
    <block wx:for="{{messages}}" wx:key="id">
      <view id="msg-{{item.id}}" class="message-item {{item.role}}">
        <view class="bubble" data-id="{{item.id}}" bindlongpress="onLongPressMessage">
          <rich-text wx:if="{{item.contentNodes && item.contentNodes.length > 0}}" nodes="{{item.contentNodes}}" class="bubble-rich" />
          <text wx:else>{{item.content}}</text>
        </view>
        <view class="time">{{item.timeText}}</view>
        <view wx:if="{{actionMessageId === item.id}}" class="message-actions" catchtap="preventBubble">
          <text class="message-action" data-id="{{item.id}}" catchtap="copyMessage">复制</text>
          <text class="message-action" data-id="{{item.id}}" catchtap="quoteMessage">引用回复</text>
        </view>
      </view>
    </block>
    <view wx:if="{{pendingReply}}" id="msg-pending" class="message-item assistant">
      <view class="bubble typing-bubble">
        <view class="typing-dots"><text class="dot"></text><text class="dot"></text><text class="dot"></text></view>
        <text class="typing-text">等待回复…</text>
      </view>
    </view>
    <view wx:if="{{messages.length === 0 && !pendingReply}}" class="empty-hint">
      <text class="empty-hint-icon">↓</text>
      <text class="empty-hint-text">输入消息与 Gateway 对话</text>
    </view>
  </scroll-view>
  <view wx:if="{{replyTo}}" class="quote-bar">
    <text class="quote-label">引用：</text>
    <text class="quote-preview">{{replyTo.preview}}</text>
    <text class="quote-close" bindtap="cancelReply">×</text>
  </view>
  <view wx:if="{{lastError}}" class="error-bar">
    <text class="error-text">{{lastError}}</text>
    <text class="error-action" bindtap="retryConnect">重试</text>
    <text class="error-action" bindtap="dismissError">×</text>
  </view>
  <view class="input-bar">
    <textarea class="input-inner" placeholder="输入消息发送给 Gateway…" value="{{inputText}}" bindinput="onInput" bindconfirm="send" auto-height="{{true}}" maxlength="-1" fixed="{{false}}" show-confirm-bar="{{false}}" />
    <button class="btn-send" size="mini" bindtap="send" disabled="{{!connected || sending}}">发送</button>
  </view>
</view>
